<section>
	<h1 class="blue" data-id="#settings"><i class="ace-icon fa fa-cog grey"></i> 快速配置工具</h1>
	
	<div class="hr hr-double hr32"></div>
	<!-- #section:settings -->
    <div class="alert alert-success alert-block">
        <button class="close" data-dismiss="alert"><i class="ace-icon fa fa-times"></i></button>

			<span class="bigger-110">
				如果您想看到各参数的真实效果，请到 <a href="#config/format" target="_blank"> 配置文件详解 </a> 查看。
			</span>
    </div>
    <div class="help-content">
        <form class="form-horizontal" role="form">
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="form-field-url">直播间地址</label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" placeholder="例如 : http://live.bilibili.com/19386" id="form-field-url" />
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="form-field-showtime">弹幕是否显示时间?</label>
                <div class="col-sm-9">
                    <label>
                        <input type="checkbox" id="form-field-showtime" class="ace ace-switch ace-switch-4 btn-flat btn-empty"  />
                        <span class="lbl"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="form-field-showusername">弹幕是否显示发布者?</label>
                <div class="col-sm-9">
                    <label>
                        <input type="checkbox" id="form-field-showusername" class="ace ace-switch ace-switch-4 btn-flat btn-empty" checked />
                        <span class="lbl"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="form-field-showwatchernum">是否显示在线人数?</label>
                <div class="col-sm-9">
                    <label>
                        <input type="checkbox" id="form-field-showwatchernum" class="ace ace-switch ace-switch-4 btn-flat btn-empty" />
                        <span class="lbl"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="form-field-show_gift">是否显示礼物?</label>
                <div class="col-sm-9">
                    <label>
                        <input type="checkbox" id="form-field-show_gift" class="ace ace-switch ace-switch-4 btn-flat btn-empty" checked />
                        <span class="lbl"></span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-3 control-label no-padding-right" for="form-field-output">是否保存弹幕源数据?</label>
                <div class="col-sm-9">
                    <label>
                        <input type="checkbox" id="form-field-output" class="ace ace-switch ace-switch-4 btn-flat btn-empty" />
                        <span class="lbl"></span>
                    </label>
                </div>
            </div>
            <div class="space-24"></div>

            <div class="clearfix">
                <button id="reset" type="reset" class="width-30 pull-left btn btn-sm">
                    <i class="ace-icon fa fa-refresh"></i>
                    <span class="bigger-110">清空</span>
                </button>

                <button id="form-field-create" type="button" class="width-65 pull-right btn btn-sm btn-success">
                    <span class="bigger-110">快速生成</span>
                    <i class="ace-icon fa fa-arrow-right icon-on-right"></i>
                </button>
            </div>
        </form>
    </div>
    <div class="hr hr-double hr32"></div>
    <div class="help-content" style="display:none" id="c-result">
        <div class="alert alert-success alert-block">
            <button class="close" data-dismiss="alert"><i class="ace-icon fa fa-times"></i></button>

			<span class="bigger-110">
				生成成功! 请在下载配置文件到助手根目录，更改命令行参数使<b>-c</b>指向刚刚下载好的配置文件，重开 <b>助手</b> 即可生效。
                <br>
                CMD文件内容:
                <br>
                <code>
                    node cli -c {替换为配置文件的相对路径}
                </code>
			</span>
        </div>
        <div class="clearfix">
            <a id="btn-save" class="pull-left btn btn-large btn-info">
                <i class="ace-icon fa fa-download"></i>
                <span class="bigger-110">直接下载配置文件 (新版IE和迅雷下载都不行哦)</span>
            </a>

        </div>
        <div class="space-4"></div>
        <div id="c-source">
            <p>
                如果下载不行，那这里也有另一种办法。</br>下面是配置文件源代码，手动保存到电脑上。
            </p>
            <p>
            <pre data-language="javascript" id="p-source"></pre>
            </p>
        </div>
    </div>

	<!-- /section:settings -->

</section>
<script type="text/javascript">
    var fileData = '';
    jQuery(function($) {
        $("#form-field-create").on('click', function (event) {
            var roomid = parseLiveUrl($('#form-field-url').val());
            if (!roomid) return alert("请填入符合格式的直播间的网址\n例如 : http://live.bilibili.com/1001");
            fileData = buildConfigFile(
                    roomid,
                    document.getElementById("form-field-showtime").checked,
                    document.getElementById("form-field-showusername").checked,
                    document.getElementById("form-field-showwatchernum").checked,
                    document.getElementById("form-field-show_gift").checked,
                    document.getElementById("form-field-output").checked);

            $('#p-source').html(fileData);
            $('#c-result').show();
        });
        $("#btn-save").on('click', function (event) {
            // IE
            if(/msie/i.test(navigator.userAgent)) {
                    var path = prompt("保存到 助手 的根目录", "C:\\config.json");
                    var content = document.getElementById("content").value;
                    content = content.replace(/\n/g, "\r\n");
                    var fso = new ActiveXObject("Scripting.FileSystemObject");
                    var s = fso.CreateTextFile(path, true);
                    s.WriteLine(fileData);
                    s.Close();
            }
            // Firefox/Chrome/Safari/Opera
            else {
                //var content = document.getElementById("content").value;
                window.open("data:application/octet-stream;base64,"
                                + Base64.encode(fileData));
            }
        });
    });

    function buildConfigFile(roomid, showtime, showusername, showwatchernum, show_gift, output){
        var data =  {
            room: {
                live_id: roomid
            },
            settings: {
                showTime: !!showtime,
                showUserName: !!showusername,
                showWatcherNum: !!showwatchernum,
                show_gift: !!show_gift,
                reconnect: true,
                output: !!output
            }
        };
        return JSON.stringify(data);
    }

    function parseLiveUrl(url){
        var reg = [
            /live.bilibili.com\/live\/(.*?).html/,
            /live.bilibili.com\/(.*?)\//
        ];
        if(reg[0].test(url)) { //旧的格式
            return url.match(reg[0])[1];
        }
        //新的格式
        url = url + "/";
        if(!reg[1].test(url)) return null;
        return (url.match(reg[1]))[1];
    }

    var Base64 = {
        _keyStr : "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
        encode : function (input) {
            var output = "";
            var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
            var i = 0;
            input = Base64._utf8_encode(input);
            while (i < input.length) {
                chr1 = input.charCodeAt(i++);
                chr2 = input.charCodeAt(i++);
                chr3 = input.charCodeAt(i++);
                enc1 = chr1 >> 2;
                enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
                enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
                enc4 = chr3 & 63;
                if (isNaN(chr2)) {
                    enc3 = enc4 = 64;
                } else if (isNaN(chr3)) {
                    enc4 = 64;
                }
                output = output +
                        this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
                        this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);
            }
            return output;
        },
        decode : function (input) {
            var output = "";
            var chr1, chr2, chr3;
            var enc1, enc2, enc3, enc4;
            var i = 0;
            input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");
            while (i < input.length) {
                enc1 = this._keyStr.indexOf(input.charAt(i++));
                enc2 = this._keyStr.indexOf(input.charAt(i++));
                enc3 = this._keyStr.indexOf(input.charAt(i++));
                enc4 = this._keyStr.indexOf(input.charAt(i++));
                chr1 = (enc1 << 2) | (enc2 >> 4);
                chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
                chr3 = ((enc3 & 3) << 6) | enc4;
                output = output + String.fromCharCode(chr1);
                if (enc3 != 64) {
                    output = output + String.fromCharCode(chr2);
                }
                if (enc4 != 64) {
                    output = output + String.fromCharCode(chr3);
                }
            }
            output = Base64._utf8_decode(output);
            return output;
        },
        _utf8_encode : function (string) {
            string = string.replace(/\r\n/g,"\n");
            var utftext = "";
            for (var n = 0; n < string.length; n++) {
                var c = string.charCodeAt(n);
                if (c < 128) {
                    utftext += String.fromCharCode(c);
                }
                else if((c > 127) && (c < 2048)) {
                    utftext += String.fromCharCode((c >> 6) | 192);
                    utftext += String.fromCharCode((c & 63) | 128);
                }
                else {
                    utftext += String.fromCharCode((c >> 12) | 224);
                    utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                    utftext += String.fromCharCode((c & 63) | 128);
                }
            }
            return utftext;
        },
        _utf8_decode : function (utftext) {
            var string = "";
            var i = 0;
            var c = 0, c1 = 0, c2 = 0, c3;
            while ( i < utftext.length ) {
                c = utftext.charCodeAt(i);
                if (c < 128) {
                    string += String.fromCharCode(c);
                    i++;
                }
                else if((c > 191) && (c < 224)) {
                    c2 = utftext.charCodeAt(i+1);
                    string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                    i += 2;
                }
                else {
                    c2 = utftext.charCodeAt(i+1);
                    c3 = utftext.charCodeAt(i+2);
                    string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                    i += 3;
                }
            }
            return string;
        }
    };
</script>
